# Руководство по интеграции с Home Assistant

## Обзор

Система MY_HOME поддерживает многоуровневую интеграцию с Home Assistant, позволяя публиковать данные устройств на разных уровнях детализации.

## Уровни публикации

### 1. Все порты (All Ports)
- **Описание**: Публикуются все доступные порты устройства
- **Использование**: Для полного мониторинга всех параметров устройства
- **Рекомендации**: Используйте для критически важных устройств, где нужен полный контроль

### 2. Группы портов (Groups)
- **Описание**: Публикуются только выбранные группы портов
- **Использование**: Для мониторинга определенных категорий данных (например, только датчики температуры)
- **Рекомендации**: Оптимально для устройств с множеством портов, где нужен выборочный мониторинг

### 3. Отдельные порты (Individual)
- **Описание**: Публикуются только выбранные отдельные порты
- **Использование**: Для точного контроля над публикуемыми данными
- **Рекомендации**: Для устройств с большим количеством портов, где нужен максимальный контроль

## Настройка интеграции

### Шаг 1: Включение интеграции
1. Откройте карточку устройства
2. Найдите раздел "Интеграция с Home Assistant"
3. Включите переключатель интеграции

### Шаг 2: Настройка параметров
- **Интервал публикации**: Как часто обновлять данные в HA (1-3600 секунд)
- **Префикс сущностей**: Префикс для всех создаваемых сущностей (по умолчанию: `my_home`)

### Шаг 3: Выбор уровня публикации
1. **Все порты**: Автоматически публикуются все порты
2. **Группы портов**: Выберите нужные группы из списка
3. **Отдельные порты**: Выберите конкретные порты из каждой группы

## Типы сущностей в Home Assistant

### Датчики (Sensors)
- **Температура**: `sensor.temperature`
- **Напряжение**: `sensor.voltage`
- **Ток**: `sensor.current`
- **Мощность**: `sensor.power`
- **Энергия**: `sensor.energy`
- **Частота**: `sensor.frequency`

### Переключатели (Switches)
- **Цифровые выходы**: `switch.digital_output`

### Бинарные датчики (Binary Sensors)
- **Цифровые входы**: `binary_sensor.digital_input`

## Структура именования сущностей

Формат: `{prefix}.device_{device_id}_{port_code}`

Примеры:
- `my_home.device_1_ads1115_00_0` - Аналоговый вход ADS1115
- `my_home.device_1_gpio_0` - GPIO порт
- `my_home.device_1_jdbbms_voltage` - Напряжение батареи

## Атрибуты сущностей

Каждая сущность содержит следующие атрибуты:
- `friendly_name`: Человекочитаемое имя
- `device_class`: Класс устройства для правильного отображения
- `unit_of_measurement`: Единица измерения
- `device`: Информация об устройстве (идентификаторы, имя, модель, производитель)
- `min_value`/`max_value`: Диапазон значений (если доступен)
- `mqtt_topic`: MQTT топик (если настроен)

## Мониторинг и статистика

### Панель статистики
- **Общая статистика**: Количество сущностей, онлайн статус, время последнего обновления
- **Статистика по уровням**: Количество сущностей по каждому уровню публикации
- **Статистика по типам**: Распределение по типам сущностей
- **Статистика по группам**: Количество сущностей в каждой группе

### Управление сущностями
- Просмотр всех опубликованных сущностей
- Статус каждой сущности (онлайн/офлайн)
- Время последнего обновления
- Прямые ссылки на сущности в Home Assistant

## Автоматизация в Home Assistant

### Примеры автоматизации

#### Мониторинг температуры
```yaml
automation:
  - alias: "High Temperature Alert"
    trigger:
      - platform: numeric_state
        entity_id: sensor.my_home_device_1_ntc_0_temperature
        above: 30
    action:
      - service: notify.mobile_app_phone
        data:
          message: "Высокая температура: {{ states('sensor.my_home_device_1_ntc_0_temperature') }}°C"
```

#### Управление нагрузкой
```yaml
automation:
  - alias: "Load Control"
    trigger:
      - platform: numeric_state
        entity_id: sensor.my_home_device_1_tac11xx_0_2_active_power
        above: 1000
    action:
      - service: switch.turn_off
        entity_id: switch.my_home_device_1_gpio_0
```

## Рекомендации по использованию

### Для начинающих
1. Начните с уровня "Все порты" для одного устройства
2. Изучите созданные сущности в Home Assistant
3. Настройте базовые автоматизации

### Для продвинутых пользователей
1. Используйте уровень "Группы портов" для оптимизации
2. Настройте индивидуальные порты для критических параметров
3. Создайте сложные автоматизации с использованием множества сущностей

### Оптимизация производительности
- Используйте более длинные интервалы публикации для не критичных данных
- Выбирайте только необходимые порты для публикации
- Регулярно проверяйте статистику использования

## Устранение неполадок

### Проблема: Сущности не создаются
**Решение**: 
1. Проверьте подключение к Home Assistant
2. Убедитесь, что токен API действителен
3. Проверьте настройки интеграции

### Проблема: Данные не обновляются
**Решение**:
1. Проверьте интервал публикации
2. Убедитесь, что устройство онлайн
3. Проверьте логи системы

### Проблема: Неправильные типы сущностей
**Решение**:
1. Проверьте настройки префикса
2. Убедитесь в правильности выбора портов
3. Пересоздайте сущности при необходимости

## API Endpoints

### Получение настроек
```
GET /api/devices/{device_id}/ha-settings
```

### Сохранение настроек
```
POST /api/devices/{device_id}/ha-settings
```

### Публикация данных
```
POST /api/devices/{device_id}/publish-to-ha
```

### Получение сущностей
```
GET /api/devices/{device_id}/ha-entities
```

### Тест подключения
```
GET /api/ha/test-connection
```

## Конфигурация Home Assistant

### Добавление в configuration.yaml
```yaml
# Автоматическое обнаружение устройств MY_HOME
discovery:
  enable:
    - my_home

# Настройки уведомлений
notify:
  - platform: group
    name: my_home_alerts
    services:
      - mobile_app_phone
      - telegram
```

### Создание групп
```yaml
group:
  my_home_devices:
    name: MY_HOME Devices
    entities:
      - sensor.my_home_device_1_*
      - switch.my_home_device_1_*
      - binary_sensor.my_home_device_1_*
```

## Заключение

Интеграция с Home Assistant предоставляет мощные возможности для мониторинга и автоматизации устройств MY_HOME. Выбор правильного уровня публикации и настройка автоматизации позволят создать эффективную систему умного дома.


