# Настройка бэкапа для Home Assistant

## Проблема
При создании бэкапа аддона через Home Assistant размер бэкапа составляет ~600МБ, хотя данные занимают всего ~2МБ. Это происходит из-за включения Docker образа в бэкап.

## Решение

### 1. Автоматическое решение (рекомендуется)
В файле `config.yaml` добавлен параметр `map`, который указывает Home Assistant включать в бэкап только указанные папки:

```yaml
map:
  - data
  - data_src
```

Это означает, что при создании бэкапа аддона будут включены только папки `data` и `data_src`, исключив Docker образ.

### 2. Ручное создание бэкапа
Если автоматическое решение не работает, можно создавать частичные бэкапы вручную:

1. Перейдите в **Настройки** > **Система** > **Резервные копии**
2. Нажмите **Создать резервную копию**
3. Выберите **Частичная резервная копия**
4. Отметьте только папку с данными аддона (обычно `/addons/local/my_home_devices/data`)
5. Исключите Docker контейнеры и образы
6. Создайте бэкап

### 3. Автоматизация через скрипт
Создан скрипт `backup_data_only.sh` для создания бэкапа только папки данных:

```bash
# Запуск скрипта
./backup_data_only.sh
```

Скрипт:
- Создает бэкап только папок `data` и `data_src`
- Исключает Docker контейнер
- Создает файл с информацией о бэкапе
- Автоматически удаляет старые бэкапы (старше 30 дней)

### 4. Настройка автоматического бэкапа
Для автоматизации можно использовать:

#### Через Home Assistant автоматизации:
```yaml
automation:
  - alias: "Backup MY_HOME data"
    trigger:
      - platform: time
        at: "02:00:00"
    action:
      - service: shell_command.backup_my_home
```

#### Через cron в аддоне:
```bash
# Добавить в crontab
0 2 * * * /app/backup_data_only.sh
```

## Проверка размера бэкапа

После настройки размер бэкапа должен уменьшиться с ~600МБ до ~2-5МБ.

### Команды для проверки:
```bash
# Размер папки данных
du -sh /data

# Размер Docker образа
docker images | grep my_home

# Размер бэкапа
ls -lh /backup/
```

## Структура бэкапа

После настройки бэкап будет содержать:
```
backup/
├── data/                    # Основные данные приложения
│   ├── sql_app.db          # База данных
│   ├── config.yaml         # Конфигурация
│   └── backup/             # Бэкапы устройств
└── data_src/               # Исходные данные
    └── google_credentials.json
```

## Восстановление из бэкапа

1. Остановите аддон
2. Скопируйте папки `data` и `data_src` из бэкапа
3. Запустите аддон

## Примечания

- Параметр `map` в `config.yaml` работает только при создании бэкапа через Home Assistant
- Для полного бэкапа (включая Docker образ) используйте стандартную процедуру
- Рекомендуется тестировать восстановление из бэкапа перед использованием в продакшене


